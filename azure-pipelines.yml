variables:
  CI: 'true'

trigger:
- master

jobs:

- job: 'Test'
  pool:
      vmImage: 'ubuntu-16.04'
  strategy:
    matrix:
      Python352:
        python.version: '3.5.2'
        tox.env: 'clean,py35-asyncio,py35-uvloop,coverage'
      Python35:
        python.version: '3.5'
        tox.env: 'clean,py35-asyncio,py35-uvloop,coverage'
      Python36:
        python.version: '3.6'
        tox.env: 'clean,py36-asyncio,py36-uvloop,coverage'
      Python37:
        python.version: '3.7'
        tox.env: 'clean,py37-asyncio,py37-uvloop,coverage'
      Python38:
        python.version: '3.8'
        tox.env: 'clean,py38-asyncio,py38-uvloop,coverage'
      PyPy35:
        python.version: 'pypy3'
        tox.env: 'clean,pypy35-asyncio,coverage'

  steps:
  - task: UsePythonVersion@0
    displayName: 'Set Python 3.7 for tox'
    inputs:
      versionSpec: '3.7'
      addToPath: false
    name: toxPython
  - script: $(toxPython.pythonLocation)/bin/pip install --upgrade pip
    displayName: 'Upgrade pip'
  - script: $(toxPython.pythonLocation)/bin/pip install --upgrade tox tox-venv
    displayName: 'Install tox'
  - task: UsePythonVersion@0
    condition: not(in(variables['python.version'], '3.5.2', '3.8'))
    inputs:
      versionSpec: '$(python.version)'
      architecture: 'x64'
    displayName: 'Use Python $(python.version) for tests'
  - script: |
      sudo add-apt-repository ppa:deadsnakes
      sudo apt-get update
      sudo apt-get install -y --no-install-recommends python$(python.version)-dev python$(python.version)-distutils
    condition: in(variables['python.version'], '3.8')
    displayName: 'Install Python $(python.version) from the deadsnakes PPA for tests'
  - script: $(toxPython.pythonLocation)/bin/tox -e $(tox.env)
    displayName: 'Run Tox (env: $(tox.env))'
  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: 'test-results/**/results.xml'
      testRunTitle: '$(python.version) Test Run'
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      failIfCoverageEmpty: true
